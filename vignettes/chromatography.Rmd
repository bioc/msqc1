<!--
%\VignetteIndexEntry{LC Observations - Retention Time Stability}
%\VignetteEngine{knitr::knitr}
-->


<script type="text/javascript"
  src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

---
title: "LC Observations - Retention Time Stability"
author: "Tobias Kockmann, Christian Trachsel, and Christian Panse"
date: "29 February 2016"

---

```{r, echo = FALSE, message = FALSE}
if (!require(msqc1)){
  ## try http:// if https:// URLs are not supported
  source("https://bioconductor.org/biocLite.R")
  biocLite("msqc1")
}
```

This vignette file is thought to demonstrate the retention time stability of the `msqc1_8rep` and `msqc1_dil` data contained in the `msqc1` R package.

# Problem: Retention Time (RT) form different LC-MS platforms are often not comparable (duration, offset).

# Solution: Normalization 

- define a reference platfrom (QTRAP)
- for each platform build a linear model (in the following we use the `stats::lm` function) and map platfrom the RT space of the corresbonding platform into reference platform RT space (by using the `stats::predict.lm` method)
- scale the normalized RT values into \([0, 1]\) space. \(f:N \rightarrow [0,1]\)
- visualize the normalized RT values

The code below shows the used R functions for the applied RT normalization.

```{r}
msqc1:::.normalize_rt
```

The `reshape_rt` method is used for reshaping the data from long to wide format which ease the the model building in the `msqc1:::.normalize_rt` method above.

```{r}
msqc1:::.reshape_rt
```

The following R code are some helper functions designed to ease the visualization of the `msqc1_8rep` and `msqc1_dil`  RT values.

```{r}
msqc1:::.plot_rt_8rep

msqc1:::.plot_rt_dil
```


# 8 Technical Replicates

Prepare the training data for the linear model.
```{r echo=TRUE, fig.width=10, fig.height=10, fig.retina=3, warning=FALSE}
S.training.8rep <- msqc1:::.reshape_rt(msqc1_8rep, peptides=peptides)
```


```{r echo=TRUE, fig.width=15, fig.height=9, fig.retina=3, warning=FALSE}
msqc1:::.plot_rt_8rep(msqc1_8rep, peptides=peptides, xlab='Replicate Id')
```
**8 replicate retention time** - The graph displays the raw retention time (in minutes) verus the replicate Id of each sample. Each panel displays one LC-MS platform. On some platforms the loading phase was recorded (TRIPLETOF, QTRAP) while on the other platforms not.


The following code will apply the retention time normalization for the `msqc_8rep` data:

```{r echo=TRUE, fig.width=15, fig.height=9, fig.retina=3, warning=FALSE}
msqc1_8rep.norm <- msqc1:::.normalize_rt(msqc1_8rep, S.training.8rep, 
                                reference_instrument = 'Retention.Time.QTRAP')

msqc1:::.plot_rt_8rep(msqc1_8rep.norm,
             peptides=peptides,
             xlab='Replicate Id',
             ylab='Normalized Retention Time')
```

**Normalized 8 replicate retention time** - The graphics displayes the normalized retention time for each peptide (heavy and light) across all plattforms. Apart from the *TAENFR* peptide all peptides show excelent elution time stability.


# Dilution Series

Prepare the training data for the linear model.
```{r echo=TRUE, fig.width=10, fig.height=10, fig.retina=3, warning=FALSE}
S.training.dil <- msqc1:::.reshape_rt(msqc1_dil, peptides=peptides)
```

```{r echo=TRUE, fig.width=15, fig.height=9, fig.retina=3, warning=FALSE}
msqc1:::.plot_rt_dil(msqc1_dil, peptides, xlab='Replicate Id', ylab='Raw Retention Time')
msqc1_dil.norm <- msqc1:::.normalize_rt(msqc1_dil, 
                                        S.training.dil, 
                                        reference_instrument = 'Retention.Time.QTRAP')

msqc1:::.plot_rt_dil(msqc1_dil.norm, peptides=peptides, ylab="Normalized Retention Time")
```


# LC Gradient Comparison

```{r echo=FALSE, fig.width=10, fig.height=5, fig.retina=3, warning=FALSE}
op <- par(mfrow=c(1,2), mar=c(4,4,1,1))


plot(msqc1_8rep.norm$Retention.Time ~ msqc1_8rep$Retention.Time, 
     pch=as.integer(msqc1_8rep.norm$Peptide.Sequence),
     col=msqc1_8rep.norm$instrument,
     xlim=c(0,100))

legend("bottomright", 
       as.character(unique(msqc1_8rep.norm$instrument)),
       col= unique(msqc1_8rep.norm$instrument), 
       pch=as.integer(unique(msqc1_8rep.norm$instrument)))

plot(msqc1_dil.norm$Retention.Time ~ msqc1_dil$Retention.Time, 
     pch=as.integer(msqc1_dil.norm$Peptide.Sequence),
     col=msqc1_dil.norm$instrument,
     xlim=c(0,100))

legend("bottomright", 
       as.character(unique(msqc1_dil.norm$instrument)),
       col= unique(msqc1_dil.norm$instrument), 
       pch=as.integer(unique(msqc1_dil.norm$instrument)))

```

**LC Gradient Comparison** - the graphs compare the LC gradient of each platform by plotting the normalized RT values again the raw rt values for the  `msqc1_8rep` (left) and `msqc1_dil` (right) data.


# Session information

```{r}
sessionInfo()
```

